# workflow name
name: Continuous Integration

# fire on
on: [push, pull_request]

#########
# actions
#########
# actions/checkout@v4.2.2
# actions/setup-python@v5.3.0
# mysterypaintwo/rookbot/install
# mysterypaintwo/rookbot/test

#########
# runners
# https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners
#########
# ubuntu-latest

jobs:
  # Test
  install-test:
    name: ğŸ§®
    runs-on: ${{ matrix.os-name }}
    continue-on-error: True

    strategy:
      matrix:
        os-name: [ ubuntu-latest ]
        python-version: [ "3.12" ]
    steps:
      # checkout commit
      - name: âœ”ï¸Checkout commit
        uses: actions/checkout@v4.2.2
      # install python
      - name: ğŸ’¿Install Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: ${{ matrix.python-version }}
      # python version
      - name: ğŸPython Version
        shell: bash
        run: |
          python --version
      # install
      - name: ğŸ’¿Call Install
        uses: ./.github/actions/install
        with:
          calling-job: test
          os-name: ${{ matrix.os-name }}
          python-version: ${{ matrix.python-version }}
      # Analyze used GitHub Actions
      - name: Analyze used GitHub Actions
        shell: bash
        run: |
          python ./resources/ci/common/list_actions.py
      # test
      - name: â±ï¸Call Test
        uses: ./.github/actions/test

      # Send Discord Notification to Updates
      - name: Build Discord Notification Payload
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_UPDATES }}
        run: |
          python ./resources/ci/common/prepare_discord_notif.py
        if: contains(github.ref, 'main') ||
          contains(github.ref, 'stable') ||
          contains(github.ref, 'unstable') ||
          contains(github.ref, 'castIe')

  # Prepare Pages
  pages-prepare:
    name: ğŸŒ->ğŸ“¦
    runs-on: ${{ matrix.os-name }}
    needs: [install-test]

    strategy:
      matrix:
        os-name: [ ubuntu-latest ]
        python-version: [ "3.12" ]

    steps:
      # checkout commit
      - name: âœ”ï¸Checkout commit
        uses: actions/checkout@v4.2.2
      # get parent dir
      - name: ğŸ“Get Parent Directory
        id: parentDir
        uses: ./.github/actions/get-parent-dir
      # download appversion artifact
      - name: ğŸ”½Download AppVersion Artifact
        uses: actions/download-artifact@v4.1.8
        with:
          name: appversion-build-${{ matrix.os-name }}-py${{ matrix.python-version }}
          path: ${{ steps.parentDir.outputs.parentDir }}/build
      # Prepare Pages
      - name: ğŸŒ->ğŸ“¦Prepare GitHub Pages
        shell: bash
        run: |
          python ./resources/ci/common/prepare_pages.py
      # upload pages artifact for later step
      - name: ğŸ”¼Upload Pages Artifact
        uses: actions/upload-artifact@v4.4.3
        with:
          name: pages-${{ matrix.os-name }}
          path: ${{ steps.parentDir.outputs.parentDir }}/pages

  # Deploy Pages
  pages-deploy:
    name: ğŸŒ->ğŸš€
    runs-on: ${{ matrix.os-name }}
    needs: [pages-prepare]

    strategy:
      matrix:
        os-name: [ ubuntu-latest ]

    steps:
      # checkout commit
      - name: âœ”ï¸Checkout commit
        uses: actions/checkout@v4.2.2
      # download pages artifact
      - name: ğŸ”½Download Pages Artifact
        uses: actions/download-artifact@v4.1.8
        with:
          name: pages-${{ matrix.os-name }}
          path: ./
      # Prepare actor for GH-Pages
      - name: ğŸ“Prepare actor for GH-Pages
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
      # List Differences
      - name: â–List Differences
        shell: bash
        run: |
          git diff --name-status --cached
      # Set Commit
      - name: â•Set Commit (MAIN)
        shell: bash
        run: |
          git commit -q -F commit.txt
          git log
        if: contains(github.ref, 'main')
      # Push to GH-Pages
      - name: ğŸš€Push to GH-Pages (MAIN)
        shell: bash
        run: |
          git push
        if: contains(github.ref, 'main')
